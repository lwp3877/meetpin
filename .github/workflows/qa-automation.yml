# íŒŒì¼ê²½ë¡œ: .github/workflows/qa-automation.yml
# ðŸŽ¯ MeetPin QA Automation & Deployment Verification
# ì‹œë‹ˆì–´ QA ì—”ì§€ë‹ˆì–´ Â· í…ŒìŠ¤íŒ… ì˜¤í† ë©”ì´í„° Â· ë°°í¬ ê²€ì¦ ì „ë¬¸ê°€

name: "ðŸš€ QA Automation & Deployment Verification"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test Environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - development
      test_type:
        description: 'Test Type'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - smoke
        - performance
        - security
        - accessibility

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ðŸ” 1ë‹¨ê³„: ì‚¬ì „ ê²€ì¦ - ì½”ë“œ í’ˆì§ˆ ë° ë¹Œë“œ ê²€ì¦
  pre-validation:
    name: "ðŸ” Pre-validation & Build Check"
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.changes.outputs.should-run }}
      build-success: ${{ steps.build.outputs.success }}
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸ“ TypeScript Type Check"
        run: pnpm typecheck

      - name: "ðŸ§¹ ESLint Code Quality Check"
        run: pnpm lint

      - name: "ðŸ”§ Build Application"
        id: build
        run: |
          pnpm build
          echo "success=true" >> $GITHUB_OUTPUT

      - name: "ðŸ§ª Unit Tests"
        run: pnpm test

      - name: "ðŸ“Š Check for Changes"
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            # Check if relevant files changed
            if git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -E "\.(ts|tsx|js|jsx|json|md)$|e2e/|\.github/"; then
              echo "should-run=true" >> $GITHUB_OUTPUT
            else
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          fi

  # ðŸŽ­ 2ë‹¨ê³„: E2E í…ŒìŠ¤íŒ… - í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì € ì‚¬ìš©ìž ì—¬ì • ê²€ì¦
  e2e-testing:
    name: "ðŸŽ­ E2E Testing - ${{ matrix.project }}"
    runs-on: ubuntu-latest
    needs: pre-validation
    if: needs.pre-validation.outputs.should-run-tests == 'true' && needs.pre-validation.outputs.build-success == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: 
          - chromium
          - firefox
          - webkit
          - mobile-chrome
          - mobile-safari
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸŽ­ Install Playwright Browsers"
        run: pnpm playwright install --with-deps

      - name: "ðŸš€ Start Development Server"
        run: |
          pnpm build
          pnpm start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: "ðŸ§ª Run E2E Tests - ${{ matrix.project }}"
        run: |
          pnpm e2e --project=${{ matrix.project }} --reporter=html,json,junit
        env:
          CI: true
          PLAYWRIGHT_HTML_REPORT: playwright-report-${{ matrix.project }}

      - name: "ðŸ“¸ Upload Test Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.project }}
          path: |
            playwright-report-${{ matrix.project }}/
            test-results/
          retention-days: 30

      - name: "ðŸ“Š Upload Test Results to GitHub"
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: E2E Test Results - ${{ matrix.project }}
          path: test-results/junit.xml
          reporter: java-junit
          fail-on-error: false

  # ðŸ”’ 3ë‹¨ê³„: ë³´ì•ˆ & ì„±ëŠ¥ ê²€ì¦
  security-performance:
    name: "ðŸ”’ Security & Performance Analysis"
    runs-on: ubuntu-latest
    needs: pre-validation
    if: needs.pre-validation.outputs.should-run-tests == 'true'
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸŽ­ Install Playwright"
        run: pnpm playwright install --with-deps chromium

      - name: "ðŸš€ Start Application"
        run: |
          pnpm build
          pnpm start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: "ðŸ”’ Security & Performance Tests"
        run: pnpm e2e e2e/performance-security.spec.ts --project=chromium
        env:
          CI: true

      - name: "ðŸ“ˆ Lighthouse Performance Audit"
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './lighthouse.config.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ðŸŒ 4ë‹¨ê³„: í”„ë¡œë•ì…˜ ë°°í¬ ê²€ì¦
  production-verification:
    name: "ðŸŒ Production Deployment Verification"
    runs-on: ubuntu-latest
    needs: [pre-validation, e2e-testing]
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸŽ­ Install Playwright"
        run: pnpm playwright install --with-deps chromium

      - name: "â³ Wait for Vercel Deployment"
        uses: UnlyEd/github-action-await-vercel@v1
        if: github.event_name == 'push'
        with:
          deployment-url: https://meetpin-weld.vercel.app
          timeout: 300

      - name: "ðŸ§ª Production Smoke Tests"
        run: pnpm e2e e2e/production-quick-test.spec.ts --project=chromium
        env:
          CI: true
          TEST_URL: https://meetpin-weld.vercel.app

      - name: "ðŸ” Detailed Production Tests"
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'full')
        run: pnpm e2e e2e/detailed-production-test.spec.ts --project=chromium
        env:
          CI: true
          TEST_URL: https://meetpin-weld.vercel.app

      - name: "ðŸ“Š Production Health Check"
        run: |
          curl -f https://meetpin-weld.vercel.app/api/health || exit 1
          echo "âœ… Production health check passed"

  # ðŸ“ 5ë‹¨ê³„: QA ê²°ê³¼ ë¦¬í¬íŒ… ë° PR ì½”ë©˜íŠ¸
  qa-reporting:
    name: "ðŸ“ QA Results & PR Comments"
    runs-on: ubuntu-latest
    needs: [pre-validation, e2e-testing, security-performance, production-verification]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ“¥ Download Test Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: test-results/

      - name: "ðŸ“Š Generate QA Summary Report"
        id: qa-summary
        run: |
          echo "## ðŸŽ¯ QA Automation Results Summary" > qa-report.md
          echo "" >> qa-report.md
          echo "### ðŸ“‹ Test Execution Overview" >> qa-report.md
          echo "- **Pre-validation**: ${{ needs.pre-validation.result }}" >> qa-report.md
          echo "- **E2E Testing**: ${{ needs.e2e-testing.result }}" >> qa-report.md
          echo "- **Security & Performance**: ${{ needs.security-performance.result }}" >> qa-report.md
          echo "- **Production Verification**: ${{ needs.production-verification.result }}" >> qa-report.md
          echo "" >> qa-report.md
          
          # Test results analysis
          if [[ "${{ needs.e2e-testing.result }}" == "success" ]]; then
            echo "âœ… **E2E Tests**: All user journeys verified across browsers" >> qa-report.md
          else
            echo "âŒ **E2E Tests**: Some tests failed - check artifacts" >> qa-report.md
          fi
          
          if [[ "${{ needs.security-performance.result }}" == "success" ]]; then
            echo "âœ… **Security & Performance**: All checks passed" >> qa-report.md
          else
            echo "âŒ **Security & Performance**: Issues detected" >> qa-report.md
          fi
          
          echo "" >> qa-report.md
          echo "### ðŸ”— Detailed Reports" >> qa-report.md
          echo "- [Playwright Test Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> qa-report.md
          echo "- [Performance Metrics](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> qa-report.md
          echo "" >> qa-report.md
          echo "### ðŸ“± Tested Browsers & Devices" >> qa-report.md
          echo "- âœ… Desktop: Chrome, Firefox, Safari" >> qa-report.md
          echo "- âœ… Mobile: Chrome (Pixel 5), Safari (iPhone 12)" >> qa-report.md
          echo "" >> qa-report.md
          echo "---" >> qa-report.md
          echo "*ðŸ¤– Generated by QA Automation System*" >> qa-report.md
          
          # Set output for PR comment
          echo "qa-summary=$(cat qa-report.md)" >> $GITHUB_OUTPUT

      - name: "ðŸ’¬ Comment QA Results on PR"
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const qaReport = fs.readFileSync('qa-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: qaReport
            });

  # ðŸš¨ 6ë‹¨ê³„: ì‹¤íŒ¨ ì•Œë¦¼ (Slack/Email)
  failure-notification:
    name: "ðŸš¨ Failure Notification"
    runs-on: ubuntu-latest
    needs: [pre-validation, e2e-testing, security-performance, production-verification]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: "ðŸ“§ Send Failure Notification"
        run: |
          echo "ðŸš¨ Critical: QA automation detected failures in main branch"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Failed Jobs:"
          echo "- Pre-validation: ${{ needs.pre-validation.result }}"
          echo "- E2E Testing: ${{ needs.e2e-testing.result }}"
          echo "- Security & Performance: ${{ needs.security-performance.result }}"
          echo "- Production Verification: ${{ needs.production-verification.result }}"
          echo ""
          echo "ðŸ”— Action URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"