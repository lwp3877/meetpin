# .github/workflows/ci.yml
# MeetPin ì§€ì†ì  í†µí•© íŒŒì´í”„ë¼ì¸
# ì½”ë“œ í’ˆì§ˆ, íƒ€ì… ì•ˆì „ì„±, í…ŒìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ê²€ì¦í•©ë‹ˆë‹¤

name: ğŸš€ MeetPin CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ Mock ë°ì´í„° ì‚¬ìš©
  NEXT_PUBLIC_USE_MOCK_DATA: true
  # ìºì‹œ íš¨ìœ¨ì„±ì„ ìœ„í•œ Node.js ì„¤ì •
  NODE_OPTIONS: --max_old_space_size=4096

jobs:
  # ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ” TypeScript íƒ€ì… ê²€ì‚¬
        run: pnpm typecheck

      - name: ğŸ§¹ ESLint ê²€ì‚¬
        run: pnpm lint

      - name: ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: pnpm build

  # ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Jest ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: pnpm test

  # ğŸ­ E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: ğŸ­ E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: pnpm playwright install --with-deps

      - name: ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: pnpm build

      - name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: pnpm e2e --reporter=list

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7