# .github/workflows/security-audit.yml
# ðŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬ ë° ì„œí”Œë¼ì´ì²´ì¸ ë³´ì•ˆ

name: "ðŸ”’ Security Audit & Supply Chain"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (KST 11ì‹œ)ì— ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
  dependency-audit:
    name: "ðŸ” Dependency Security Audit"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ” PNPM Audit"
        run: |
          echo "ðŸ” Running PNPM security audit..."
          pnpm audit --audit-level high
          
          # ì·¨ì•½ì  ê°œìˆ˜ í™•ì¸
          VULNERABILITIES=$(pnpm audit --audit-level high --json | jq '.metadata.vulnerabilities.total // 0')
          echo "Found $VULNERABILITIES vulnerabilities"
          
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "âš ï¸ Security vulnerabilities found!"
            pnpm audit --audit-level high
            exit 1
          else
            echo "âœ… No high-severity vulnerabilities found"
          fi

      - name: "ðŸ“ Generate Audit Report"
        if: always()
        run: |
          echo "ðŸ“ Generating audit report..."
          pnpm audit --json > audit-report.json
          
          # ìš”ì•½ ìƒì„±
          echo "## ðŸ”’ Security Audit Summary" > audit-summary.md
          echo "- **Scan Date**: $(date)" >> audit-summary.md
          echo "- **Total Dependencies**: $(jq '.metadata.dependencies.total // 0' audit-report.json)" >> audit-summary.md
          echo "- **Vulnerabilities**: $(jq '.metadata.vulnerabilities.total // 0' audit-report.json)" >> audit-summary.md
          echo "- **High Severity**: $(jq '.metadata.vulnerabilities.high // 0' audit-report.json)" >> audit-summary.md
          echo "- **Critical Severity**: $(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)" >> audit-summary.md

      - name: "ðŸ“¤ Upload Audit Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: |
            audit-report.json
            audit-summary.md
          retention-days: 30

  # ë¼ì´ì„¼ìŠ¤ ê²€ì‚¬
  license-check:
    name: "ðŸ“œ License Compliance Check"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸ“¦ Install License Checker"
        run: npm install -g license-checker

      - name: "ðŸ“œ Check Licenses"
        run: |
          echo "ðŸ“œ Checking package licenses..."
          
          # í—ˆìš©ëœ ë¼ì´ì„¼ìŠ¤ ëª©ë¡
          ALLOWED_LICENSES="MIT,ISC,BSD-2-Clause,BSD-3-Clause,Apache-2.0,CC0-1.0,Unlicense,WTFPL"
          
          # ë¼ì´ì„¼ìŠ¤ ì²´í¬
          license-checker --summary --onlyAllow "$ALLOWED_LICENSES" --excludePrivatePackages
          
          # ìƒì„¸ ë¦¬í¬íŠ¸ ìƒì„±
          license-checker --json --out license-report.json
          
          echo "âœ… License compliance check completed"

      - name: "ðŸ“¤ Upload License Report"
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  # CodeQL ë³´ì•ˆ ë¶„ì„
  codeql:
    name: "ðŸ” CodeQL Security Analysis"
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ” Initialize CodeQL"
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: "ðŸ” Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # SBOM (Software Bill of Materials) ìƒì„±
  sbom-generation:
    name: "ðŸ“‹ SBOM Generation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸ“¦ Install CycloneDX"
        run: npm install -g @cyclonedx/cyclonedx-npm

      - name: "ðŸ“‹ Generate SBOM"
        run: |
          echo "ðŸ“‹ Generating Software Bill of Materials..."
          
          # CycloneDX SBOM ìƒì„±
          cyclonedx-npm --output-file sbom.json --spec-version 1.4
          
          # SPDX í˜•ì‹ìœ¼ë¡œë„ ìƒì„±
          npm list --json --all > npm-dependencies.json
          
          echo "âœ… SBOM generated successfully"

      - name: "ðŸ” Sign SBOM"
        run: |
          echo "ðŸ” Signing SBOM with timestamp..."
          
          # ê°„ë‹¨í•œ í•´ì‹œ ê¸°ë°˜ ì„œëª… (ì‹¤ì œë¡œëŠ” cosign ë“± ì‚¬ìš© ê¶Œìž¥)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          HASH=$(sha256sum sbom.json | cut -d' ' -f1)
          
          echo "{
            \"timestamp\": \"$TIMESTAMP\",
            \"sbom_hash\": \"$HASH\",
            \"signer\": \"github-actions[bot]\",
            \"workflow\": \"${{ github.workflow }}\",
            \"run_id\": \"${{ github.run_id }}\"
          }" > sbom-signature.json
          
          echo "âœ… SBOM signed with metadata"

      - name: "ðŸ“¤ Upload SBOM"
        uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: |
            sbom.json
            sbom-signature.json
            npm-dependencies.json
          retention-days: 90

  # Lockfile ê²€ì¦
  lockfile-verification:
    name: "ðŸ”’ Lockfile Verification"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Setup Node.js & PNPM"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install PNPM"
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: "ðŸ”’ Verify Lockfile Integrity"
        run: |
          echo "ðŸ”’ Verifying lockfile integrity..."
          
          # Lockfile ë¬´ê²°ì„± ê²€ì¦
          if ! pnpm install --frozen-lockfile --ignore-scripts; then
            echo "âŒ Lockfile verification failed!"
            echo "The pnpm-lock.yaml file may be out of sync with package.json"
            exit 1
          fi
          
          echo "âœ… Lockfile integrity verified"

      - name: "ðŸ“Š Generate Lockfile Report"
        run: |
          echo "ðŸ“Š Analyzing lockfile..."
          
          # ì§ì ‘ ì˜ì¡´ì„± vs ê°„ì ‘ ì˜ì¡´ì„± ë¶„ì„
          DIRECT_DEPS=$(jq '.dependencies // {} | length' package.json)
          TOTAL_DEPS=$(pnpm list --depth=Infinity --json | jq '.[0].dependencies // {} | length')
          
          echo "## ðŸ“Š Dependency Analysis" > lockfile-report.md
          echo "- **Direct Dependencies**: $DIRECT_DEPS" >> lockfile-report.md
          echo "- **Total Dependencies**: $TOTAL_DEPS" >> lockfile-report.md
          echo "- **Dependency Ratio**: $(echo "scale=2; $TOTAL_DEPS / $DIRECT_DEPS" | bc)" >> lockfile-report.md
          
          # ì¤‘ë³µ íŒ¨í‚¤ì§€ í™•ì¸
          echo "### ðŸ” Duplicate Package Analysis" >> lockfile-report.md
          pnpm why react >> lockfile-report.md || echo "No react duplicates" >> lockfile-report.md

      - name: "ðŸ“¤ Upload Lockfile Report"
        uses: actions/upload-artifact@v4
        with:
          name: lockfile-report
          path: lockfile-report.md
          retention-days: 30

  # ê²°ê³¼ í†µí•© ë° ì•Œë¦¼
  security-summary:
    name: "ðŸ“Š Security Summary & Notification"
    runs-on: ubuntu-latest
    needs: [dependency-audit, license-check, codeql, sbom-generation, lockfile-verification]
    if: always()
    
    steps:
      - name: "ðŸ“¥ Download All Reports"
        uses: actions/download-artifact@v4
        with:
          path: security-reports/

      - name: "ðŸ“Š Generate Security Summary"
        run: |
          echo "ðŸ“Š Generating comprehensive security summary..."
          
          echo "# ðŸ”’ MeetPin Security Audit Report" > security-summary.md
          echo "**Generated**: $(date)" >> security-summary.md
          echo "**Workflow**: ${{ github.workflow }}" >> security-summary.md
          echo "**Commit**: ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## ðŸ“‹ Audit Results" >> security-summary.md
          echo "- **Dependency Audit**: ${{ needs.dependency-audit.result }}" >> security-summary.md
          echo "- **License Check**: ${{ needs.license-check.result }}" >> security-summary.md
          echo "- **CodeQL Analysis**: ${{ needs.codeql.result }}" >> security-summary.md
          echo "- **SBOM Generation**: ${{ needs.sbom-generation.result }}" >> security-summary.md
          echo "- **Lockfile Verification**: ${{ needs.lockfile-verification.result }}" >> security-summary.md
          echo "" >> security-summary.md
          
          # ì‹¤íŒ¨í•œ ìž‘ì—…ì´ ìžˆëŠ”ì§€ í™•ì¸
          FAILED_JOBS=""
          [ "${{ needs.dependency-audit.result }}" != "success" ] && FAILED_JOBS="$FAILED_JOBS dependency-audit"
          [ "${{ needs.license-check.result }}" != "success" ] && FAILED_JOBS="$FAILED_JOBS license-check"
          [ "${{ needs.codeql.result }}" != "success" ] && FAILED_JOBS="$FAILED_JOBS codeql"
          [ "${{ needs.sbom-generation.result }}" != "success" ] && FAILED_JOBS="$FAILED_JOBS sbom-generation"
          [ "${{ needs.lockfile-verification.result }}" != "success" ] && FAILED_JOBS="$FAILED_JOBS lockfile-verification"
          
          if [ -n "$FAILED_JOBS" ]; then
            echo "## âš ï¸ Failed Jobs" >> security-summary.md
            echo "The following security checks failed: $FAILED_JOBS" >> security-summary.md
            echo "" >> security-summary.md
            echo "**Action Required**: Review the failed jobs and address any security issues." >> security-summary.md
          else
            echo "## âœ… All Security Checks Passed" >> security-summary.md
            echo "No security issues detected in this audit." >> security-summary.md
          fi

      - name: "ðŸ“¤ Upload Security Summary"
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

      - name: "ðŸ’¬ Comment on PR"
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('security-summary.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } catch (error) {
              console.log('Could not read security summary:', error);
            }