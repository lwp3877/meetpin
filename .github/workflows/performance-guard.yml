# ì„±ëŠ¥ íšŒê·€ ë°©ì§€ ì›Œí¬í”Œë¡œìš°
# PR ì‹œ Lighthouse CI ì‹¤í–‰ ë° ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦
# ì˜ˆì‚° ì´ˆê³¼ ì‹œ PR ì‹¤íŒ¨ ì²˜ë¦¬

name: ğŸš€ Performance Regression Guard

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'next.config.js'
      - 'tailwind.config.ts'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  performance-audit:
    name: ì„±ëŠ¥ ê°ì‚¬ ë° ì˜ˆì‚° ê²€ì¦
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµë¥¼ ìœ„í•´

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: |
          echo "ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ ì¤‘..."
          pnpm build

      - name: ë¹Œë“œ ì‚¬ì´ì¦ˆ ë¶„ì„
        run: |
          echo "ğŸ“Š ë¹Œë“œ ì‚¬ì´ì¦ˆ ë¶„ì„ ì¤‘..."

          # ë²ˆë“¤ ì‚¬ì´ì¦ˆ ì¸¡ì •
          BUNDLE_SIZE=$(du -sh .next/static | cut -f1)
          echo "ë²ˆë“¤ ì‚¬ì´ì¦ˆ: $BUNDLE_SIZE"
          echo "bundle_size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT

          # JavaScript ë²ˆë“¤ ìƒì„¸ ë¶„ì„
          echo "=== JavaScript ë²ˆë“¤ ë¶„ì„ ==="
          find .next/static/chunks -name "*.js" -exec ls -lh {} \; | sort -k5 -hr | head -10

          # í° íŒŒì¼ ê²½ê³  (1MB ì´ˆê³¼)
          LARGE_FILES=$(find .next/static -size +1M -type f)
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ 1MB ì´ˆê³¼ íŒŒì¼ ë°œê²¬:"
            echo "$LARGE_FILES"
          fi

      - name: Lighthouse CI ì„¤ì¹˜
        run: |
          echo "ğŸ  Lighthouse CI ì„¤ì¹˜ ì¤‘..."
          npm install -g @lhci/cli@0.12.x

      - name: ê°œë°œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        run: |
          echo "ğŸš€ ê°œë°œ ì„œë²„ ì‹œì‘ ì¤‘..."
          pnpm start &

          # ì„œë²„ ì¤€ë¹„ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
          for i in {1..60}; do
            if curl -s http://localhost:3000/api/healthz > /dev/null; then
              echo "âœ… ì„œë²„ ì¤€ë¹„ ì™„ë£Œ (${i}ì´ˆ)"
              break
            fi
            echo "â³ ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/60)"
            sleep 1
          done

      - name: Lighthouse ì„±ëŠ¥ ê°ì‚¬
        run: |
          echo "ğŸ” Lighthouse ì„±ëŠ¥ ê°ì‚¬ ì‹¤í–‰ ì¤‘..."

          # Lighthouse CI ì„¤ì • íŒŒì¼ ìƒì„±
          cat > lighthouserc.js << 'EOF'
          module.exports = {
            ci: {
              collect: {
                url: [
                  'http://localhost:3000',
                  'http://localhost:3000/map',
                  'http://localhost:3000/room/new'
                ],
                numberOfRuns: 3,
                settings: {
                  chromeFlags: '--no-sandbox --headless --disable-gpu',
                  preset: 'desktop',
                  throttling: {
                    rttMs: 40,
                    throughputKbps: 10240,
                    cpuSlowdownMultiplier: 1
                  }
                }
              },
              assert: {
                assertions: {
                  'categories:performance': ['error', {minScore: 0.75}],
                  'categories:accessibility': ['error', {minScore: 0.9}],
                  'categories:best-practices': ['error', {minScore: 0.8}],
                  'categories:seo': ['error', {minScore: 0.8}],
                  
                  // Core Web Vitals ì˜ˆì‚°
                  'largest-contentful-paint': ['error', {maxNumericValue: 4000}],
                  'cumulative-layout-shift': ['error', {maxNumericValue: 0.25}],
                  'total-blocking-time': ['error', {maxNumericValue: 600}],
                  'first-contentful-paint': ['error', {maxNumericValue: 3000}],
                  
                  // ë¦¬ì†ŒìŠ¤ ì˜ˆì‚°
                  'total-byte-weight': ['error', {maxNumericValue: 3000000}], // 3MB
                  'unused-javascript': ['warn', {maxNumericValue: 500000}], // 500KB
                  'unused-css-rules': ['warn', {maxNumericValue: 100000}], // 100KB
                  
                  // ì„±ëŠ¥ ë©”íŠ¸ë¦­
                  'speed-index': ['error', {maxNumericValue: 5000}],
                  'interactive': ['error', {maxNumericValue: 6000}]
                }
              },
              upload: {
                target: 'temporary-public-storage'
              }
            }
          }
          EOF

          # Lighthouse CI ì‹¤í–‰
          lhci autorun

      - name: ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦
        id: perf-budget
        run: |
          echo "ğŸ’° ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦ ì¤‘..."

          # Lighthouse ê²°ê³¼ íŒŒì‹±
          RESULTS_DIR=".lighthouseci"
          if [ -d "$RESULTS_DIR" ]; then
            echo "=== Lighthouse ê²°ê³¼ ìš”ì•½ ==="
            
            # ì„±ëŠ¥ ì ìˆ˜ ì¶”ì¶œ
            for file in $RESULTS_DIR/*.json; do
              if [ -f "$file" ]; then
                PERF_SCORE=$(jq -r '.categories.performance.score // 0' "$file")
                LCP=$(jq -r '.audits."largest-contentful-paint".numericValue // 0' "$file")
                CLS=$(jq -r '.audits."cumulative-layout-shift".numericValue // 0' "$file")
                TBT=$(jq -r '.audits."total-blocking-time".numericValue // 0' "$file")
                
                echo "ì„±ëŠ¥ ì ìˆ˜: $(echo "$PERF_SCORE * 100" | bc -l | cut -d. -f1)/100"
                echo "LCP: ${LCP}ms"
                echo "CLS: $CLS"
                echo "TBT: ${TBT}ms"
                
                # ì˜ˆì‚° ì´ˆê³¼ ì²´í¬
                if (( $(echo "$PERF_SCORE < 0.75" | bc -l) )); then
                  echo "budget_violation=performance_score" >> $GITHUB_OUTPUT
                fi
                
                if (( $(echo "$LCP > 4000" | bc -l) )); then
                  echo "budget_violation=lcp" >> $GITHUB_OUTPUT
                fi
                
                if (( $(echo "$CLS > 0.25" | bc -l) )); then
                  echo "budget_violation=cls" >> $GITHUB_OUTPUT
                fi
              fi
            done
          fi

      - name: ì´ì „ ë²„ì „ê³¼ ì„±ëŠ¥ ë¹„êµ
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë³€í™” ë¶„ì„ ì¤‘..."

          # ê¸°ì¤€ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
          git fetch origin main

          # í˜„ì¬ ë¸Œëœì¹˜ì˜ ë²ˆë“¤ ì‚¬ì´ì¦ˆ
          CURRENT_SIZE=$(du -s .next/static | cut -f1)

          # main ë¸Œëœì¹˜ë¡œ ì„ì‹œ ì „í™˜
          git stash push -m "temp-stash-for-comparison"
          git checkout origin/main

          # ê¸°ì¤€ ë²„ì „ ë¹Œë“œ (ì‹¤íŒ¨í•´ë„ ê³„ì†)
          if pnpm build; then
            BASELINE_SIZE=$(du -s .next/static | cut -f1)
            SIZE_DIFF=$((CURRENT_SIZE - BASELINE_SIZE))
            SIZE_CHANGE_PERCENT=$(echo "scale=2; $SIZE_DIFF * 100 / $BASELINE_SIZE" | bc -l)
            
            echo "ê¸°ì¤€ ë²ˆë“¤ ì‚¬ì´ì¦ˆ: ${BASELINE_SIZE}KB"
            echo "í˜„ì¬ ë²ˆë“¤ ì‚¬ì´ì¦ˆ: ${CURRENT_SIZE}KB"
            echo "ë³€í™”ëŸ‰: ${SIZE_DIFF}KB (${SIZE_CHANGE_PERCENT}%)"
            
            # ë²ˆë“¤ ì‚¬ì´ì¦ˆ 10% ì´ˆê³¼ ì¦ê°€ ì‹œ ê²½ê³ 
            if (( $(echo "$SIZE_CHANGE_PERCENT > 10" | bc -l) )); then
              echo "âš ï¸ ë²ˆë“¤ ì‚¬ì´ì¦ˆ 10% ì´ˆê³¼ ì¦ê°€"
              echo "bundle_size_violation=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ê¸°ì¤€ ë²„ì „ ë¹Œë“œ ì‹¤íŒ¨ - ë¹„êµ ìƒëµ"
          fi

          # ì›ë˜ ë¸Œëœì¹˜ë¡œ ë³µì›
          git checkout -
          git stash pop || true

      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
        if: always()
        run: |
          echo "ğŸ“‹ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."

          cat > perf-report.md << 'EOF'
          ## ğŸš€ ì„±ëŠ¥ ê°ì‚¬ ê²°ê³¼

          ### ğŸ“Š Lighthouse ì ìˆ˜
          EOF

          # Lighthouse ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¶”ê°€
          if [ -d ".lighthouseci" ]; then
            echo "| ë©”íŠ¸ë¦­ | ì ìˆ˜/ê°’ | ìƒíƒœ |" >> perf-report.md
            echo "|--------|---------|------|" >> perf-report.md
            
            for file in .lighthouseci/*.json; do
              if [ -f "$file" ]; then
                PERF=$(jq -r '.categories.performance.score // 0' "$file")
                PERF_SCORE=$(echo "$PERF * 100" | bc -l | cut -d. -f1)
                
                LCP=$(jq -r '.audits."largest-contentful-paint".numericValue // 0' "$file")
                CLS=$(jq -r '.audits."cumulative-layout-shift".numericValue // 0' "$file")
                TBT=$(jq -r '.audits."total-blocking-time".numericValue // 0' "$file")
                
                PERF_STATUS=$([ "$PERF_SCORE" -ge 75 ] && echo "âœ…" || echo "âŒ")
                LCP_STATUS=$([ "$(echo "$LCP <= 4000" | bc -l)" = "1" ] && echo "âœ…" || echo "âŒ")
                CLS_STATUS=$([ "$(echo "$CLS <= 0.25" | bc -l)" = "1" ] && echo "âœ…" || echo "âŒ")
                
                echo "| Performance | ${PERF_SCORE}/100 | $PERF_STATUS |" >> perf-report.md
                echo "| LCP | ${LCP}ms | $LCP_STATUS |" >> perf-report.md
                echo "| CLS | $CLS | $CLS_STATUS |" >> perf-report.md
                echo "| TBT | ${TBT}ms | - |" >> perf-report.md
                break
              fi
            done
          fi

          echo "" >> perf-report.md
          echo "### ğŸ“¦ ë²ˆë“¤ ë¶„ì„" >> perf-report.md
          echo "- í˜„ì¬ ë²ˆë“¤ ì‚¬ì´ì¦ˆ: $(du -sh .next/static | cut -f1)" >> perf-report.md

          # ì˜ˆì‚° ìœ„ë°˜ ìš”ì•½
          if [ -n "${{ steps.perf-budget.outputs.budget_violation }}" ]; then
            echo "" >> perf-report.md
            echo "### âš ï¸ ì„±ëŠ¥ ì˜ˆì‚° ìœ„ë°˜" >> perf-report.md
            echo "- ìœ„ë°˜ í•­ëª©: ${{ steps.perf-budget.outputs.budget_violation }}" >> perf-report.md
            echo "- **ì´ PRì€ ì„±ëŠ¥ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**" >> perf-report.md
          fi

      - name: PRì— ì„±ëŠ¥ ë¦¬í¬íŠ¸ ëŒ“ê¸€ ì¶”ê°€
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('perf-report.md', 'utf8');
              
              // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ğŸš€ ì„±ëŠ¥ ê°ì‚¬ ê²°ê³¼')
              );
              
              if (botComment) {
                // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: report
                });
              } else {
                // ìƒˆ ëŒ“ê¸€ ìƒì„±
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              }
            } catch (error) {
              console.log('ì„±ëŠ¥ ë¦¬í¬íŠ¸ ëŒ“ê¸€ ì¶”ê°€ ì‹¤íŒ¨:', error);
            }

      - name: ì„±ëŠ¥ ì˜ˆì‚° ìœ„ë°˜ ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬
        if: steps.perf-budget.outputs.budget_violation
        run: |
          echo "âŒ ì„±ëŠ¥ ì˜ˆì‚° ìœ„ë°˜ìœ¼ë¡œ ì¸í•œ CI ì‹¤íŒ¨"
          echo "ìœ„ë°˜ í•­ëª©: ${{ steps.perf-budget.outputs.budget_violation }}"
          echo ""
          echo "ì„±ëŠ¥ ê°œì„  í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”:"
          echo "1. ë¶ˆí•„ìš”í•œ JavaScript ì œê±°"
          echo "2. ì´ë¯¸ì§€ ìµœì í™”"
          echo "3. ì½”ë“œ ìŠ¤í”Œë¦¬íŒ… ì ìš©"
          echo "4. ë²ˆë“¤ ë¶„ì„: pnpm analyze:bundle"
          exit 1

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            perf-report.md
          retention-days: 30
