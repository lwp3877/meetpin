# Synthetic ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°
# 10ë¶„ë§ˆë‹¤ í”„ë¡œë•ì…˜ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸

name: ğŸš¨ Synthetic Monitoring

on:
  schedule:
    # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (*/10 * * * *)
    - cron: '*/10 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  
env:
  PROD_DOMAIN: meetpin-weld.vercel.app # í”„ë¡œë•ì…˜ ë„ë©”ì¸
  TIMEOUT_SECONDS: 30
  
jobs:
  synthetic-monitoring:
    name: ì—…íƒ€ì„ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ  í™ˆí˜ì´ì§€ ìƒíƒœ í™•ì¸
        id: check-home
        run: |
          echo "ğŸ  í™ˆí˜ì´ì§€ ì²´í¬ ì¤‘..."
          
          # ì‘ë‹µì‹œê°„ ë° ìƒíƒœì½”ë“œ í™•ì¸
          RESPONSE=$(curl -w "%{http_code},%{time_total},%{time_connect}" \
                          -s -o /dev/null \
                          --max-time ${{ env.TIMEOUT_SECONDS }} \
                          https://${{ env.PROD_DOMAIN }}/ || echo "000,999,999")
          
          HTTP_CODE=$(echo $RESPONSE | cut -d',' -f1)
          RESPONSE_TIME=$(echo $RESPONSE | cut -d',' -f2)
          CONNECT_TIME=$(echo $RESPONSE | cut -d',' -f3)
          
          echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          echo "connect_time=$CONNECT_TIME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š í™ˆí˜ì´ì§€ ê²°ê³¼: HTTP $HTTP_CODE, ì‘ë‹µì‹œê°„ ${RESPONSE_TIME}s"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ í™ˆí˜ì´ì§€ ì‹¤íŒ¨: HTTP $HTTP_CODE"
            exit 1
          fi
          
          # ì‘ë‹µì‹œê°„ ê²½ê³  (5ì´ˆ ì´ˆê³¼)
          if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "âš ï¸ ëŠë¦° ì‘ë‹µì‹œê°„: ${RESPONSE_TIME}s"
            echo "slow_response=true" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ—ºï¸ ì§€ë„ í˜ì´ì§€ ìƒíƒœ í™•ì¸  
        id: check-map
        run: |
          echo "ğŸ—ºï¸ ì§€ë„ í˜ì´ì§€ ì²´í¬ ì¤‘..."
          
          RESPONSE=$(curl -w "%{http_code},%{time_total}" \
                          -s -o /dev/null \
                          --max-time ${{ env.TIMEOUT_SECONDS }} \
                          https://${{ env.PROD_DOMAIN }}/map || echo "000,999")
          
          HTTP_CODE=$(echo $RESPONSE | cut -d',' -f1)
          RESPONSE_TIME=$(echo $RESPONSE | cut -d',' -f2)
          
          echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ì§€ë„ í˜ì´ì§€ ê²°ê³¼: HTTP $HTTP_CODE, ì‘ë‹µì‹œê°„ ${RESPONSE_TIME}s"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ì§€ë„ í˜ì´ì§€ ì‹¤íŒ¨: HTTP $HTTP_CODE"
            exit 1
          fi
          
      - name: ğŸ¥ í—¬ìŠ¤ì²´í¬ API í™•ì¸
        id: check-health
        run: |
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ API ì²´í¬ ì¤‘..."
          
          # JSON ì‘ë‹µ íŒŒì‹± í¬í•¨
          HEALTH_RESPONSE=$(curl -s --max-time ${{ env.TIMEOUT_SECONDS }} \
                                 https://${{ env.PROD_DOMAIN }}/api/healthz || echo '{"status":"error"}')
          
          HTTP_CODE=$(curl -w "%{http_code}" -s -o /dev/null \
                           --max-time ${{ env.TIMEOUT_SECONDS }} \
                           https://${{ env.PROD_DOMAIN }}/api/healthz || echo "000")
          
          echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ê²°ê³¼: HTTP $HTTP_CODE"
          
          # JSONì—ì„œ status ì¶”ì¶œ
          HEALTH_STATUS=$(echo "$HEALTH_RESPONSE" | jq -r '.status // "error"')
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ] || [ "$HEALTH_STATUS" != "healthy" ]; then
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: HTTP $HTTP_CODE, Status: $HEALTH_STATUS"
            echo "$HEALTH_RESPONSE" | jq '.' || echo "$HEALTH_RESPONSE"
            exit 1
          fi
          
      - name: ğŸ”’ ë³´ì•ˆ í—¤ë” í™•ì¸
        id: check-security
        run: |
          echo "ğŸ”’ ë³´ì•ˆ í—¤ë” ì²´í¬ ì¤‘..."
          
          # í•„ìˆ˜ ë³´ì•ˆ í—¤ë” í™•ì¸
          HEADERS=$(curl -I -s --max-time ${{ env.TIMEOUT_SECONDS }} \
                         https://${{ env.PROD_DOMAIN }}/ || echo "")
          
          # CSP í—¤ë” í™•ì¸
          if echo "$HEADERS" | grep -i "content-security-policy" > /dev/null; then
            echo "âœ… CSP í—¤ë” ì¡´ì¬"
            echo "csp_present=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ CSP í—¤ë” ëˆ„ë½"
            echo "csp_present=false" >> $GITHUB_OUTPUT
          fi
          
          # X-Frame-Options í™•ì¸  
          if echo "$HEADERS" | grep -i "x-frame-options" > /dev/null; then
            echo "âœ… X-Frame-Options í—¤ë” ì¡´ì¬"
            echo "xframe_present=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ X-Frame-Options í—¤ë” ëˆ„ë½"
            echo "xframe_present=false" >> $GITHUB_OUTPUT
          fi
          
          # X-Content-Type-Options í™•ì¸
          if echo "$HEADERS" | grep -i "x-content-type-options" > /dev/null; then
            echo "âœ… X-Content-Type-Options í—¤ë” ì¡´ì¬"
          else
            echo "âš ï¸ X-Content-Type-Options í—¤ë” ëˆ„ë½"
          fi
          
      - name: ğŸ“Š ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ğŸ¯ Synthetic ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ìš”ì•½"
          echo "=================================="
          echo "í™ˆí˜ì´ì§€: HTTP ${{ steps.check-home.outputs.status_code }}, ${â€‹{ steps.check-home.outputs.response_time }}s"
          echo "ì§€ë„í˜ì´ì§€: HTTP ${{ steps.check-map.outputs.status_code }}, ${â€‹{ steps.check-map.outputs.response_time }}s"  
          echo "í—¬ìŠ¤ì²´í¬: HTTP ${{ steps.check-health.outputs.status_code }}, ${{ steps.check-health.outputs.health_status }}"
          echo "CSP í—¤ë”: ${{ steps.check-security.outputs.csp_present }}"
          echo "X-Frame: ${{ steps.check-security.outputs.xframe_present }}"
          echo "=================================="
          
      - name: ğŸ“§ ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼
        if: failure()
        run: |
          # Slack ì›¹í›…ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì „ì†¡
          if [ -n "${{ secrets.SYNTHETIC_SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
                 --data "{
                   \"text\": \"ğŸš¨ ë°‹í•€ ì„œë¹„ìŠ¤ ì¥ì•  ê°ì§€\",
                   \"blocks\": [
                     {
                       \"type\": \"section\",
                       \"text\": {
                         \"type\": \"mrkdwn\",
                         \"text\": \"*ğŸš¨ ë°‹í•€ Synthetic ëª¨ë‹ˆí„°ë§ ì‹¤íŒ¨*\\n\\nâ€¢ ì‹œê°„: $(date)\\nâ€¢ ë„ë©”ì¸: ${{ env.PROD_DOMAIN }}\\nâ€¢ ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}\\nâ€¢ ì‹¤í–‰ ID: ${{ github.run_id }}\"
                       }
                     },
                     {
                       \"type\": \"section\",
                       \"text\": {
                         \"type\": \"mrkdwn\",
                         \"text\": \"*ì²´í¬ ê²°ê³¼:*\\nâ€¢ í™ˆ: HTTP ${{ steps.check-home.outputs.status_code || 'FAIL' }}\\nâ€¢ ì§€ë„: HTTP ${{ steps.check-map.outputs.status_code || 'FAIL' }}\\nâ€¢ í—¬ìŠ¤: ${{ steps.check-health.outputs.health_status || 'FAIL' }}\"
                       }
                     },
                     {
                       \"type\": \"actions\",
                       \"elements\": [
                         {
                           \"type\": \"button\",
                           \"text\": {
                             \"type\": \"plain_text\",
                             \"text\": \"ì›Œí¬í”Œë¡œìš° ë³´ê¸°\"
                           },
                           \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                         }
                       ]
                     }
                   ]
                 }" \
                 ${{ secrets.SYNTHETIC_SLACK_WEBHOOK_URL }}
          else
            echo "âš ï¸ Slack ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "SYNTHETIC_SLACK_WEBHOOK_URL ì‹œí¬ë¦¿ì„ ì„¤ì •í•˜ì„¸ìš”"
          fi
          
      - name: ğŸ“§ ì‹¤íŒ¨ ì‹œ ì´ë©”ì¼ ì•Œë¦¼ (ë”ë¯¸)
        if: failure()
        run: |
          echo "ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ (ë”ë¯¸ êµ¬í˜„)"
          echo "ìˆ˜ì‹ ì: ${{ secrets.SYNTHETIC_ALERT_EMAIL || 'ops@example.com' }}"
          echo "ì œëª©: [ë°‹í•€] Synthetic ëª¨ë‹ˆí„°ë§ ì‹¤íŒ¨ - $(date)"
          echo "ë‚´ìš©: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ í•„ìš”"
          echo ""
          echo "ì‹¤ì œ êµ¬í˜„ ì‹œ SendGrid, AWS SES ë“± ì´ë©”ì¼ ì„œë¹„ìŠ¤ ì—°ë™ í•„ìš”"